# 의료 청구/연계 시스템

## 프로젝트 개요
- **이름**: 의료 청구/연계 시스템 (Medical Claims & Integration System)
- **목표**: 의료기관의 진료비 청구 및 외부기관 연계 업무를 관리하는 데모 시스템
- **주요 기능**:
  - 환자 정보 관리
  - 진료 명세서 작성 및 관리
  - 사전점검 및 청구 제출
  - 외부기관 연계 (자격조회, 산정특례, 실손보험)
  - 심사 결과 관리
  - 입금 관리
  - 대시보드 및 통계
  - **원무업무 통합** (접수, 수납, 대기환자) - NEW!

## URLs
- **개발 서버**: https://3000-iq497tzk9xe87er1t7mrt-b9b802c4.sandbox.novita.ai
- **로컬 서버**: http://localhost:3000
- **GitHub**: (아직 배포되지 않음)
- **상태**: ✅ 모든 기능 정상 동작 (2026-01-09 테스트 완료)

## 데이터 아키텍처

### 데이터 모델
1. **patients**: 환자 기본 정보
   - 환자번호, 이름, 생년월일, 성별, 보험정보 등

2. **claims**: 진료 명세서
   - 청구번호, 환자ID, 진료일, 진단정보, 금액, 상태 등

3. **claim_items**: 진료 항목 상세
   - 항목코드, 항목명, 단가, 수량, 급여율 등

4. **claim_submissions**: 청구 제출 이력
   - 제출번호, 제출일시, 상태, 응답 데이터 등

5. **external_integrations**: 외부기관 연계 이력
   - 연계유형, 요청/응답 데이터, 상태 등

6. **review_results**: 심사 결과
   - 심사 유형, 원청구액, 인정액, 삭감액, 지급액 등

7. **payments**: 입금 관리
   - 입금예정일, 입금액, 입금유형, 상태 등

### 저장소 서비스
- **Cloudflare D1**: SQLite 기반 관계형 데이터베이스
  - 로컬 개발: `--local` 플래그로 로컬 SQLite 사용
  - 프로덕션: Cloudflare D1 분산 데이터베이스

### 데이터 흐름
1. **환자 등록** → 자격조회 → 환자 정보 저장
2. **명세서 작성** → 진료 항목 추가 → 금액 자동 계산
3. **사전점검** → 유효성 검증 → 오류/경고 표시
4. **청구 제출** → 심사평가원 전송(시뮬레이션) → 제출 이력 저장
5. **심사 결과 수신**(시뮬레이션) → 결과 저장 → 상태 업데이트
6. **입금 관리** → 입금 확인 → 상태 업데이트

## 사용자 가이드

### 1. 대시보드
- 전체 환자 수, 이번 달 청구액, 입금 대기 건수 등 주요 통계 확인
- 최근 청구 내역 조회

### 2. 환자 관리
- 환자 목록 조회
- 환자 등록 (환자번호, 이름, 생년월일, 보험정보 등)
- 자격조회 기능으로 보험 자격 확인

### 3. 명세서 관리
- 명세서 목록 조회 (상태별 필터링)
- 새 명세서 작성
  - 환자 선택
  - 진료 정보 입력 (진료일, 진료과, 진단코드 등)
  - 진료 항목 추가 (항목코드, 항목명, 단가, 수량)
  - 금액 자동 계산 (총 진료비, 보험자부담금, 본인부담금)
- 사전점검 실행 (유효성 검증)
- 청구 제출 (심사평가원 전송 시뮬레이션)
- 명세서 상세 보기

### 4. 외부기관 연계
- 자격조회: 환자의 보험 자격 확인
- 산정특례 승인: 특정 질환에 대한 급여 확대 승인
- 실손보험 연계: 실손보험 청구 연계
- 진료정보 교류: 타 의료기관과 진료 정보 공유
- 연계 이력 조회

### 5. 심사 결과 관리
- 청구한 명세서에 대한 심사 결과 생성(시뮬레이션)
- 심사 유형: 적정, 부분삭감, 전체삭감, 보류
- 원청구액, 인정액, 삭감액, 지급예정액 확인

### 6. 입금 관리
- 입금 예정 내역 조회
- 입금 확인 처리
- 입금 유형별 관리 (보험자부담금, 본인부담금, 추가청구)

## 주요 기능 상세

### ✅ 현재 완료된 기능
1. **환자 관리**
   - ✅ 환자 목록 조회
   - ✅ 환자 상세 정보 조회
   - ✅ 환자 등록
   - ✅ 자격조회 연계 (시뮬레이션)

2. **명세서 관리**
   - ✅ 명세서 목록 조회 (상태별 필터링)
   - ✅ 명세서 상세 조회 (진료 항목 포함)
   - ✅ 명세서 생성 (자동 청구번호 생성)
   - ✅ 명세서 수정
   - ✅ 명세서 삭제
   - ✅ 진료 항목 추가/삭제
   - ✅ 금액 자동 재계산

3. **청구 기능**
   - ✅ 사전점검 (유효성 검증)
   - ✅ 청구 제출 (시뮬레이션)
   - ✅ 청구 이력 조회
   - ✅ 중간 진료비 계산 (자동)

4. **외부기관 연계**
   - ✅ 자격조회 (시뮬레이션)
   - ✅ 산정특례 승인 (시뮬레이션)
   - ✅ 실손보험 연계 (시뮬레이션)
   - ✅ 연계 이력 조회

5. **심사 결과 관리**
   - ✅ 심사 결과 생성 (시뮬레이션)
   - ✅ 심사 결과 조회
   - ✅ 적정/삭감 처리

6. **입금 관리**
   - ✅ 입금 내역 조회
   - ✅ 입금 확인 처리
   - ✅ 입금 상태 관리

7. **대시보드**
   - ✅ 주요 통계 (환자 수, 청구액, 입금 대기)
   - ✅ 최근 청구 내역
   - ✅ 상태별 명세서 현황

### ✅ 새로 추가된 기능 (2026-01-11)
1. **명세서 관리**
   - ✅ 환자 등록 모달 UI
   - ✅ 명세서 작성 모달 UI
   - ✅ 진료 항목 추가 모달 UI
   - ✅ 명세서 엑셀 다운로드 (CSV 형식)
   - ⏳ 명세서 일괄 업로드

2. **청구 기능**
   - ✅ 보완 청구 기능
   - ✅ 추가 청구 기능
   - ✅ 청구 취소 기능

3. **사후관리**
   - ⏳ 보완 요청 처리
   - ⏳ 이의신청 관리

4. **통계 및 리포트**
   - ✅ 월별 청구 통계 API
   - ✅ 삭감율 분석 API
   - ✅ 진료과별 통계 API
   - ✅ 대시보드 차트 시각화 (Chart.js)
   - ✅ 상태별 파이 차트
   - ✅ 월별 추세 그래프

### 🚧 미구현 기능 (향후 개발 권장)
1. **명세서 관리**
   - ⏳ 명세서 일괄 업로드

2. **사후관리**
   - ⏳ 보완 요청 처리
   - ⏳ 이의신청 관리

3. **통계 및 리포트**
   - ⏳ 리포트 출력 (PDF 등)

5. **사용자 관리**
   - ⏳ 로그인/로그아웃
   - ⏳ 사용자 권한 관리
   - ⏳ 감사 로그

## 권장 개발 순서

### Phase 1: UI 완성도 개선 (우선순위: 높음)
1. **모달 UI 구현**
   - 환자 등록 모달
   - 명세서 작성 모달  
   - 진료 항목 추가 모달
   - 입력 폼 유효성 검증

2. **데이터 시각화 개선**
   - 차트 추가 (Chart.js)
   - 월별 추세 그래프
   - 상태별 파이 차트

### Phase 2: 기능 확장 (우선순위: 중간)
1. **보완/추가 청구 기능**
   - 보완 청구 워크플로우
   - 추가 청구 처리
   - 이력 관리

2. **엑셀 다운로드**
   - 명세서 엑셀 출력
   - 통계 리포트 다운로드

### Phase 3: 고급 기능 (우선순위: 낮음)
1. **사용자 인증/권한**
   - JWT 기반 인증
   - 역할 기반 접근 제어

2. **실시간 알림**
   - 심사 결과 알림
   - 입금 알림

## 배포

### 플랫폼
- **Cloudflare Pages**: 엣지 배포 플랫폼
- **기술 스택**: Hono + TypeScript + Cloudflare D1

### 배포 상태
- ✅ 로컬 개발 서버: 활성
- ❌ Cloudflare Pages 프로덕션: 미배포

### 로컬 개발
```bash
# 데이터베이스 마이그레이션
npm run db:migrate:local

# 샘플 데이터 삽입
npm run db:seed

# 빌드
npm run build

# 개발 서버 시작
pm2 start ecosystem.config.cjs

# 로그 확인
pm2 logs --nostream

# 서비스 중지
pm2 delete webapp
```

### 프로덕션 배포 (Cloudflare Pages)
```bash
# 1. Cloudflare API 키 설정 (최초 1회)
# setup_cloudflare_api_key 도구 사용

# 2. 프로덕션 D1 데이터베이스 생성
npx wrangler d1 create webapp-production

# 3. wrangler.jsonc에 database_id 업데이트

# 4. 프로덕션 마이그레이션
npm run db:migrate:prod

# 5. Cloudflare Pages 프로젝트 생성
npx wrangler pages project create webapp --production-branch main

# 6. 배포
npm run deploy:prod
```

## 프로젝트 구조

```
src/
├── index.tsx              # 메인 앱 및 라우터 통합
├── routes/                # 기능별 API 라우트
│   ├── patients.ts        # 환자 관리 API
│   ├── claims.ts          # 명세서 관리 API
│   ├── integrations.ts    # 외부기관 연계 API
│   ├── payments.ts        # 입금 관리 API
│   └── dashboard.ts       # 대시보드 통계 API
├── utils/                 # 유틸리티 함수
│   └── claimUtils.ts      # 명세서 관련 유틸리티
└── types/                 # 타입 정의
    └── bindings.ts        # Cloudflare Workers 타입 정의
```

### 구조 개선 사항
- **모듈화**: API 라우트를 기능별로 분리하여 유지보수성 향상
- **재사용성**: 공통 유틸리티 함수를 별도 모듈로 분리
- **타입 안전성**: 타입 정의를 중앙화하여 관리 용이
- **확장성**: 새로운 기능 추가 시 해당 모듈만 수정하면 됨

## 기술 스택

### 백엔드
- **Hono**: 경량 웹 프레임워크
- **Cloudflare Workers**: 엣지 런타임
- **Cloudflare D1**: SQLite 기반 분산 데이터베이스
- **TypeScript**: 타입 안전성

### 프론트엔드
- **Vanilla JavaScript**: 프레임워크 없는 순수 JS
- **Tailwind CSS**: 유틸리티 기반 CSS 프레임워크
- **Font Awesome**: 아이콘
- **Axios**: HTTP 클라이언트
- **Chart.js**: 데이터 시각화 라이브러리

### 개발 도구
- **Vite**: 빌드 도구
- **Wrangler**: Cloudflare CLI
- **PM2**: 프로세스 관리

## 샘플 데이터

시스템에는 다음 샘플 데이터가 포함되어 있습니다:
- 5명의 샘플 환자
- 5개의 샘플 명세서 (다양한 상태)
- 진료 항목 데이터
- 청구 제출 이력
- 외부기관 연계 이력
- 심사 결과 데이터
- 입금 내역

## 시뮬레이션 기능

실제 외부 시스템과 연동하지 않고, 다음 기능들을 시뮬레이션합니다:

1. **자격조회**: 항상 '유효' 응답
2. **산정특례 승인**: 70% 확률로 승인
3. **실손보험 연계**: 무작위 보험사 할당
4. **심사 결과**: 무작위로 적정/부분삭감/전체삭감/보류 결정
5. **청구 제출**: 즉시 '접수완료' 응답

## API 엔드포인트

### 환자 관리
- `GET /api/patients` - 환자 목록
- `GET /api/patients/:id` - 환자 상세
- `POST /api/patients` - 환자 등록

### 명세서 관리
- `GET /api/claims` - 명세서 목록
- `GET /api/claims/:id` - 명세서 상세
- `POST /api/claims` - 명세서 생성
- `PUT /api/claims/:id` - 명세서 수정
- `DELETE /api/claims/:id` - 명세서 삭제

### 진료 항목
- `POST /api/claims/:id/items` - 진료 항목 추가
- `DELETE /api/claims/:claim_id/items/:item_id` - 진료 항목 삭제

### 청구 기능
- `POST /api/claims/:id/precheck` - 사전점검
- `POST /api/claims/:id/submit` - 청구 제출
- `POST /api/claims/:id/supplement` - 보완 청구
- `POST /api/claims/:id/additional` - 추가 청구
- `POST /api/claims/:id/cancel` - 청구 취소
- `GET /api/claims/:id/submissions` - 청구 이력

### 진료 항목
- `POST /api/claims/:id/items` - 진료 항목 추가
- `DELETE /api/claims/:claim_id/items/:item_id` - 진료 항목 삭제

### 외부기관 연계
- `POST /api/integrations/eligibility` - 자격조회
- `POST /api/integrations/special-approval` - 산정특례 승인
- `POST /api/integrations/private-insurance` - 실손보험 연계
- `GET /api/integrations` - 연계 이력

### 심사 결과
- `POST /api/claims/:id/review-result` - 심사 결과 생성
- `GET /api/claims/:id/review-result` - 심사 결과 조회

### 입금 관리
- `GET /api/payments` - 입금 내역
- `POST /api/payments/:id/confirm` - 입금 확인

### 대시보드
- `GET /api/dashboard/stats` - 통계 데이터
- `GET /api/dashboard/monthly-stats` - 월별 청구 통계
- `GET /api/dashboard/reduction-analysis` - 삭감율 분석
- `GET /api/dashboard/department-stats` - 진료과별 통계

## 주의사항

### 데모 시스템 제약사항
- 실제 건강보험심사평가원과 연동되지 않음
- 보안 통신 프로토콜 미구현
- 실제 보험 자격 조회 불가
- 모든 외부 연계는 시뮬레이션

### Cloudflare Pages 제약사항
- CPU 시간 제한: 10-30ms
- 메모리 제한: 128MB
- 파일 시스템 접근 불가
- Node.js 특정 API 사용 불가

### 실무 적용시 고려사항
1. 실제 심사평가원 API 연동 필요
2. VPN 또는 전용선 연결 필요
3. 보안 인증서 및 암호화 모듈 필요
4. 전자서명 기능 추가 필요
5. 더 강력한 서버 환경 권장 (Node.js, AWS 등)

## 라이선스
MIT License

## 업데이트 내역
- **2026-01-11**: Phase 1 & 2 기능 개발 완료 및 버그 수정
  - 모달 UI 구현 (환자 등록, 명세서 작성, 진료 항목 추가)
  - 데이터 시각화 개선 (Chart.js - 상태별 파이 차트, 월별 추세 그래프)
  - 보완/추가/취소 청구 기능 API 구현
  - 통계 API 확장 (월별, 삭감율, 진료과별)
  - 엑셀 다운로드 기능 (CSV 형식)
  - 대시보드 차트 크기 고정 및 중복 렌더링 방지
  - Chart.js 로드 타이밍 문제 해결
  - 차트 인스턴스 관리 개선
- **2026-01-09**: 프로젝트 구조 개선 및 코드 리팩토링
  - API 라우트를 기능별 모듈로 분리 (patients, claims, integrations, payments, dashboard)
  - 유틸리티 함수 분리 (claimUtils.ts)
  - 타입 정의 중앙화 (types/bindings.ts)
  - 사용하지 않는 renderer.tsx 파일 제거
  - src/index.tsx를 간결한 라우터 통합 파일로 리팩토링 (663줄 → 50줄)
  - 코드 가독성 및 유지보수성 향상
- **2026-01-09**: 원무업무 통합 페이지 추가
  - 오늘 접수/수납 통계
  - 대기 환자 목록
  - 빠른 작업 버튼
  - 오늘 수납 내역

## 마지막 업데이트
2026-01-09
